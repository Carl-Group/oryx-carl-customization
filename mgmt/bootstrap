#!/usr/bin/env bash

# Execute by: bash xxx.sh or bash zzz/yyy/xxx.sh or ./xxx.sh or ./zzz/yyy/xxx.sh source xxx.sh
REALPATH=$(realpath ${BASH_SOURCE[0]})
SCRIPT_DIR=$(cd $(dirname ${REALPATH}) && pwd)
WORK_DIR=$(cd $(dirname ${REALPATH}) && pwd)
echo "BASH_SOURCE=${BASH_SOURCE}, REALPATH=${REALPATH}, SCRIPT_DIR=${SCRIPT_DIR}, WORK_DIR=${WORK_DIR}"
cd ${WORK_DIR}

DATA_HOME=/data
IMAGE=ossrs/srs-cloud:1
MGMT_PORT=2022
RTMP_PORT=1935
API_PORT=1985
HTTP_PORT=8080
RTC_PORT=8000
SRT_PORT=10080

echo "Stop platform container"
docker rm -f srs-cloud

echo "Start platform container"
CMD="docker run --rm --name srs-cloud -v ${DATA_HOME}:/data
    -p ${MGMT_PORT}:2022 -p ${RTMP_PORT}:1935/tcp -p ${API_PORT}:1985/tcp -p
    ${HTTP_PORT}:8080/tcp -p ${RTC_PORT}:8000/udp -p ${SRT_PORT}:10080/udp
    --restart no --detach
    ${IMAGE}"
echo $CMD && $CMD
if [[ $? -ne 0 ]]; then echo "Start platform container failed"; exit 1; fi
echo "Start platform container ok"

while true; do
    ID=$(docker ps --filter "name=srs-cloud" --format "{{.ID}}")
    if [[ -z $ID ]]; then
        echo "Platform container not found"
        exit 1
    fi

    docker ps --filter "name=srs-cloud" --format "{{.Names}} {{.ID}} {{.Ports}}"
    sleep 3
done

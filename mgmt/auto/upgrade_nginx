#!/usr/bin/env bash

CLOUD=$1
echo "Upgrade nginx script, CLOUD=$CLOUD"

# Setup nginx configuration.
if [[ ! -d /etc/nginx/default.d ]]; then
  exit 0
fi

# Overwrite the default nginx config.
cp containers/conf/nginx.conf /etc/nginx/nginx.conf && echo "Refresh nginx.conf ok"
if [[ $? -ne 0 ]]; then echo "Refresh nginx.conf failed"; exit 1; fi

# For DO Ubuntu20, use www-data as nginx user.
if [[ $CLOUD == DO ]];  then
  echo "Switch to user www-data for nginx" &&
  sed -i "s/user nginx;/user www-data;/g" /etc/nginx/nginx.conf
  if [[ $? -ne 0 ]]; then echo "Setup nginx.conf failed"; exit 1; fi
fi

# For nginx default config.
rm -f /etc/nginx/default.d/default.conf &&
cp containers/conf/nginx.default.conf /etc/nginx/default.d/default.conf &&
echo "Refresh nginx default.conf ok"
if [[ $? -ne 0 ]]; then echo "Refresh nginx default.conf failed"; exit 1; fi

# For nginx mgmt config.
rm -f /etc/nginx/default.d/mgmt.conf &&
cp containers/conf/nginx.mgmt.conf /etc/nginx/default.d/mgmt.conf &&
echo "Refresh nginx mgmt.conf ok"
if [[ $? -ne 0 ]]; then echo "Refresh nginx mgmt.conf failed"; exit 1; fi

# For nginx srs config.
rm -f /etc/nginx/default.d/srs.conf &&
cp containers/conf/nginx.srs.conf /etc/nginx/default.d/srs.conf &&
echo "Refresh nginx srs.conf ok"
if [[ $? -ne 0 ]]; then echo "Refresh nginx srs.conf failed"; exit 1; fi

# For DVR preview, create nginx location.
rm -f /etc/nginx/default.d/dvr.preview.conf &&
cp containers/conf/nginx.dvr.preview.conf /etc/nginx/default.d/dvr.preview.conf &&
echo "Refresh nginx dvr.preview.conf ok"
if [[ $? -ne 0 ]]; then echo "Refresh nginx dvr.preview.conf failed"; exit 1; fi

# For dynamic config, generated by mgmt.
if [[ -f containers/conf/nginx.dynamic.conf ]]; then
  rm -f /etc/nginx/default.d/nginx.dynamic.conf &&
  cp containers/conf/nginx.dynamic.conf /etc/nginx/default.d/dynamic.conf &&
  echo "Refresh nginx dynamic.conf ok"
  if [[ $? -ne 0 ]]; then echo "Refresh nginx dynamic.conf failed"; exit 1; fi
fi

# Reload nginx service.
systemctl reload nginx && echo "Reload nginx ok"
if [[ $? -ne 0 ]]; then echo "Reload nginx failed"; exit 1; fi


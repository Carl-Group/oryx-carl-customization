#!/usr/bin/env bash

REALPATH=$(realpath $0)
WORK_DIR=$(cd $(dirname $REALPATH) && pwd)
echo "Upgrade srs-terraform at $WORK_DIR"

TARGET_TAG=$1
TAG_NAME=$(echo $TARGET_TAG|grep '^v')
echo "The TARGET_TAG=$TARGET_TAG TAG_NAME=$TAG_NAME"

if [[ $TARGET_TAG != 'lighthouse' && $TAG_NAME == '' ]]; then
  echo "Usage: $0 <branch|tag>"
  echo "    branch|tag    The branch or tag to upgrade to."
  echo "For example:"
  echo "    $0 lighthouse"
  echo "    $0 v1.2.3"
  echo "Remark:"
  echo "    The upgrade will reset all local changes by: git checkout ."
  exit 1
fi

cd $WORK_DIR &&
git remote -v &&
git branch -vva &&
ls -lh
if [[ $? -ne 0 ]]; then echo "Prepare upgrade failed"; exit 1; fi

if [[ ! -d /usr/local/srs-terraform && $(uname -s) == 'Darwin' ]]; then
  echo "Directly finish upgrade for macOS development"
  exit 0
fi

# Try git stash first, ignore any error.
git stash 2>>upgrade.error.log
if [[ $? -ne 0 ]]; then
  echo "Warning: git stash failed, see upgrade.error.log for detail\n";
fi

echo "Upgrade code files"
git checkout . &&
git pull &&
git checkout $TARGET_TAG &&
git pull
if [[ $? -ne 0 ]]; then echo "Upgrade codes failed"; exit 1; fi

echo "Install updates"
cd .. && make install
if [[ $? -ne 0 ]]; then echo "Install updates failed"; exit 1; fi

echo "Restart service"
sudo systemctl daemon-reload &&
sudo systemctl restart srs-terraform
if [[ $? -ne 0 ]]; then echo "Restart service failed"; exit 1; fi

echo "Change permissions for generated files"
sudo chown -R lighthouse:lighthouse /usr/local/lighthouse/softwares &&
sudo chown -R lighthouse:lighthouse /usr/local/srs-terraform
if [[ $? -ne 0 ]]; then echo "Change owner failed"; exit 1; fi

echo "Upgrade OK"
